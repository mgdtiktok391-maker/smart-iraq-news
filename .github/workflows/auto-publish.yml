name: Auto Publish (Baghdad Time)

on:
  schedule:
    # 12:00 ظهرًا بغداد (09:00 UTC)
    - cron: "0 9 * * *"
    # 20:00 مساءً بغداد (17:00 UTC)
    - cron: "0 17 * * *"
  workflow_dispatch:

concurrency:
  group: auto-publish
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      PUBLISH_MODE: live
      USE_EXTERNAL_CRON: "0"
      RUN_ONCE: "1"   # ⭐⭐⭐ هذا هو المفتاح ⭐⭐⭐

      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      BLOG_URL: ${{ secrets.BLOG_URL }}
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
      REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}

      PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
      PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
      UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
      FEATURED_IMAGE_URL: ${{ secrets.FEATURED_IMAGE_URL }}

      SAFE_CALLS_PER_MIN: "3"
      AI_MAX_RETRIES: "3"
      AI_BACKOFF_BASE: "4"
      TITLE_WINDOW: "40"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client google-auth \
                      requests feedparser backoff flask apscheduler \
                      markdown bleach

      - name: Run publisher (one-shot)
        run: |
          python main.py
